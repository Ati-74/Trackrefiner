<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>helper - Trackrefiner 2025 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Trackrefiner 2025 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">Trackrefiner 2025 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Modules</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for helper</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">distance_matrix</span>


<span class="k">def</span> <span class="nf">print_progress_bar</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;â–ˆ&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call in a loop to create terminal progress bar</span>
<span class="sd">    @params:</span>
<span class="sd">        iteration   - Required  : current iteration (Int)</span>
<span class="sd">        total       - Required  : total iterations (Int)</span>
<span class="sd">        prefix      - Optional  : prefix string (Str)</span>
<span class="sd">        suffix      - Optional  : suffix string (Str)</span>
<span class="sd">        decimals    - Optional  : positive number of decimals in percent complete (Int)</span>
<span class="sd">        length      - Optional  : character length of bar (Int)</span>
<span class="sd">        fill        - Optional  : bar fill character (Str)</span>
<span class="sd">        print_end   - Optional  : end character (e.g. &quot;\r&quot;, &quot;\r\n&quot;) (Str)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;{0:.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;f}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">)))</span>
    <span class="n">filled_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">iteration</span> <span class="o">//</span> <span class="n">total</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">fill</span> <span class="o">*</span> <span class="n">filled_length</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">filled_length</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1"> |</span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">percent</span><span class="si">}</span><span class="s1">% </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="calc_movement">
<a class="viewcode-back" href="../modules.html#helper.calc_movement">[docs]</a>
<span class="k">def</span> <span class="nf">calc_movement</span><span class="p">(</span><span class="n">bac2</span><span class="p">,</span> <span class="n">bac1</span><span class="p">,</span> <span class="n">center_coordinate_columns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function computes the displacement of a bacterium (`bac1` (source) to `bac2` (target))</span>
<span class="sd">    using multiple spatial points.</span>

<span class="sd">    **The computed movements include**:</span>
<span class="sd">        - Centroid movement.</span>
<span class="sd">        - Endpoint movements (first and second endpoints).</span>
<span class="sd">        - Cross-movements between endpoints.</span>

<span class="sd">    The minimum movement among all these calculations is returned to represent the most plausible movement distance.</span>

<span class="sd">    :param pandas.Series bac2:</span>
<span class="sd">        Data for the bacterium in the next time step.</span>
<span class="sd">    :param pandas.Series bac1:</span>
<span class="sd">        Data for the bacterium in the current time step.</span>
<span class="sd">    :param dict center_coordinate_columns:</span>
<span class="sd">        A dictionary specifying the column names for the x and y coordinates of the bacterial centroids</span>
<span class="sd">        (e.g., `{&quot;x&quot;: &quot;Center_X&quot;, &quot;y&quot;: &quot;Center_Y&quot;}`).</span>

<span class="sd">    **Returns**:</span>
<span class="sd">        float:</span>

<span class="sd">        The minimum movement distance between `bac1` and `bac2`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">center_movement</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bac2</span><span class="p">[[</span><span class="n">center_coordinate_columns</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">center_coordinate_columns</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                       <span class="n">bac1</span><span class="p">[[</span><span class="n">center_coordinate_columns</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">center_coordinate_columns</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">endpoint1_1_movement</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bac2</span><span class="p">[[</span><span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                       <span class="n">bac1</span><span class="p">[[</span><span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">endpoint1_endpoint2_movement</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bac2</span><span class="p">[[</span><span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                       <span class="n">bac1</span><span class="p">[[</span><span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">endpoint2_2_movement</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bac2</span><span class="p">[[</span><span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                       <span class="n">bac1</span><span class="p">[[</span><span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">endpoint2_endpoint1_movement</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bac2</span><span class="p">[[</span><span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                       <span class="n">bac1</span><span class="p">[[</span><span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">movement</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">center_movement</span><span class="p">,</span> <span class="n">endpoint1_1_movement</span><span class="p">,</span> <span class="n">endpoint2_2_movement</span><span class="p">,</span> <span class="n">endpoint1_endpoint2_movement</span><span class="p">,</span>
                   <span class="n">endpoint2_endpoint1_movement</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">movement</span></div>



<div class="viewcode-block" id="calc_neighbors_dir_motion_all">
<a class="viewcode-back" href="../modules.html#helper.calc_neighbors_dir_motion_all">[docs]</a>
<span class="k">def</span> <span class="nf">calc_neighbors_dir_motion_all</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">neighbor_df</span><span class="p">,</span> <span class="n">division_df</span><span class="p">,</span> <span class="n">selected_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates motion alignment features for bacteria based on neighbor trajectories.</span>

<span class="sd">    :param pandas.DataFrame df:</span>
<span class="sd">        Main DataFrame containing bacterial motion and trajectory data.</span>
<span class="sd">    :param pandas.DataFrame neighbor_df:</span>
<span class="sd">        DataFrame containing neighbor information, including image and object numbers for neighbors.</span>
<span class="sd">    :param pandas.DataFrame division_df:</span>
<span class="sd">        DataFrame containing division-related indices for bacteria.</span>
<span class="sd">    :param pandas.DataFrame selected_rows:</span>
<span class="sd">        Optional DataFrame for updating specific selected rows. Default is None.</span>

<span class="sd">    :returns:</span>
<span class="sd">        pandas.DataFrame: The updated DataFrame with motion alignment features added.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;ImageNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;ObjectNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s2">&quot;TrajectoryX&quot;</span><span class="p">,</span> <span class="s2">&quot;TrajectoryY&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Total_Daughter_Mother_Length_Ratio&quot;</span><span class="p">,</span> <span class="s1">&#39;Daughter_Avg_TrajectoryX&#39;</span><span class="p">,</span> <span class="s1">&#39;Daughter_Avg_TrajectoryY&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;source_target_TrajectoryX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="s2">&quot;TrajectoryX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;source_target_TrajectoryY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="s2">&quot;TrajectoryY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;Total_Daughter_Mother_Length_Ratio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s1">&#39;source_target_TrajectoryX&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;Total_Daughter_Mother_Length_Ratio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s1">&#39;Daughter_Avg_TrajectoryX&#39;</span><span class="p">]</span>

    <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;Total_Daughter_Mother_Length_Ratio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s1">&#39;source_target_TrajectoryY&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;Total_Daughter_Mother_Length_Ratio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s1">&#39;Daughter_Avg_TrajectoryY&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">selected_rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">all_bac_neighbors</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">neighbor_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ImageNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;ObjectNumber&#39;</span><span class="p">],</span>
                                     <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;First Image Number&#39;</span><span class="p">,</span> <span class="s1">&#39;First Object Number&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_bac_neighbors</span> <span class="o">=</span> <span class="n">selected_rows</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">neighbor_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ImageNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;ObjectNumber&#39;</span><span class="p">],</span>
                                                <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;First Image Number&#39;</span><span class="p">,</span> <span class="s1">&#39;First Object Number&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="c1"># be careful: &#39;source_target_TrajectoryX&#39;, &#39;source_target_TrajectoryY&#39; is only for neighbors</span>
    <span class="n">all_bac_neighbors_info</span> <span class="o">=</span> <span class="n">all_bac_neighbors</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">temp_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Second Image Number&#39;</span><span class="p">,</span> <span class="s1">&#39;Second Object Number&#39;</span><span class="p">],</span>
                                                     <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ImageNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;ObjectNumber&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                                     <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_bac&#39;</span><span class="p">,</span> <span class="s1">&#39;_neighbor&#39;</span><span class="p">))</span>

    <span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;source_neighbors_TrajectoryX&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">all_bac_neighbors_info</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;ImageNumber_bac&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;ObjectNumber_bac&#39;</span><span class="p">])[</span><span class="s1">&#39;source_target_TrajectoryX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>

    <span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;source_neighbors_TrajectoryY&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">all_bac_neighbors_info</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;ImageNumber_bac&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;ObjectNumber_bac&#39;</span><span class="p">])[</span><span class="s1">&#39;source_target_TrajectoryY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>

    <span class="n">all_bac_neighbors_info</span> <span class="o">=</span> <span class="n">all_bac_neighbors_info</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ImageNumber_bac&#39;</span><span class="p">,</span> <span class="s1">&#39;ObjectNumber_bac&#39;</span><span class="p">],</span>
                                                                    <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>

    <span class="n">all_bac_neighbors_info</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Indices in `all_bac_neighbors_info` are not unique. This may indicate a data issue.&quot;</span><span class="p">)</span>

    <span class="c1"># update dataframe</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;Source_Neighbor_Avg_TrajectoryX&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;source_neighbors_TrajectoryX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;Source_Neighbor_Avg_TrajectoryY&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;source_neighbors_TrajectoryY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># now we should focus on target bac</span>
    <span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;source_neighbors_TrajectoryX_for_target&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">all_bac_neighbors_info</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id_bac&#39;</span><span class="p">)[</span><span class="s2">&quot;source_neighbors_TrajectoryX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;source_neighbors_TrajectoryY_for_target&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">all_bac_neighbors_info</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id_bac&#39;</span><span class="p">)[</span><span class="s2">&quot;source_neighbors_TrajectoryY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># daughters at the division time</span>
    <span class="n">all_bac_neighbors_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">division_df</span><span class="p">[</span><span class="s1">&#39;index_2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;source_neighbors_TrajectoryX_for_target&quot;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">division_df</span><span class="p">[</span><span class="s1">&#39;index_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;Source_Neighbor_Avg_TrajectoryX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">all_bac_neighbors_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">division_df</span><span class="p">[</span><span class="s1">&#39;index_2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;source_neighbors_TrajectoryY_for_target&quot;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">division_df</span><span class="p">[</span><span class="s1">&#39;index_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;Source_Neighbor_Avg_TrajectoryY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">selected_rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Motion_Alignment_Angle&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">calculate_normalized_angle_between_motion_vectors</span><span class="p">(</span>
                <span class="n">all_bac_neighbors_info</span><span class="p">[[</span><span class="s1">&#39;source_neighbors_TrajectoryX_for_target&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;source_neighbors_TrajectoryY_for_target&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">all_bac_neighbors_info</span><span class="p">[[</span><span class="s1">&#39;TrajectoryX_bac&#39;</span><span class="p">,</span> <span class="s1">&#39;TrajectoryY_bac&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># bac with nan</span>
        <span class="n">bac_with_nan</span> <span class="o">=</span> <span class="n">all_bac_neighbors_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s2">&quot;source_neighbors_TrajectoryX_for_target&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;Unexpected_Beginning&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span>

        <span class="n">prev_motion_alignment_angle</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bac_with_nan</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;Motion_Alignment_Angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_bac_neighbors_info</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;Motion_Alignment_Angle&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">calculate_normalized_angle_between_motion_vectors</span><span class="p">(</span>
                <span class="n">all_bac_neighbors_info</span><span class="p">[[</span><span class="s1">&#39;source_neighbors_TrajectoryX_for_target&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;source_neighbors_TrajectoryY_for_target&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">all_bac_neighbors_info</span><span class="p">[[</span><span class="s1">&#39;TrajectoryX_bac&#39;</span><span class="p">,</span> <span class="s1">&#39;TrajectoryY_bac&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bac_with_nan</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;Motion_Alignment_Angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_motion_alignment_angle</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Motion_Alignment_Angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Motion_Alignment_Angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="update_dataframe_with_selected_rows">
<a class="viewcode-back" href="../modules.html#helper.update_dataframe_with_selected_rows">[docs]</a>
<span class="k">def</span> <span class="nf">update_dataframe_with_selected_rows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">selected_rows</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates specific rows in a DataFrame based on another DataFrame of selected rows.</span>

<span class="sd">    This function takes an input DataFrame and updates specific rows (identified by the indices of the `selected_rows`</span>
<span class="sd">    DataFrame) with the values from the corresponding columns in `selected_rows`.</span>

<span class="sd">    :param pandas.DataFrame df:</span>
<span class="sd">        The main DataFrame to be updated.</span>
<span class="sd">    :param pandas.DataFrame selected_rows:</span>
<span class="sd">        A DataFrame containing the selected rows and their updated values. The indices of `selected_rows`</span>
<span class="sd">        must match the indices in `df` that are to be updated.</span>

<span class="sd">    :returns:</span>
<span class="sd">        pandas.DataFrame: The updated DataFrame with the following columns modified or added:</span>

<span class="sd">        - **`prev_time_step_MajorAxisLength`**:</span>
<span class="sd">          Major axis length of the bacterium from the previous time step.</span>

<span class="sd">        - **`LengthChangeRatio`**:</span>
<span class="sd">          The ratio of the major axis length between the current and previous time steps.</span>

<span class="sd">        - **Center Coordinates**:</span>
<span class="sd">          - `prev_time_step_center_x`: X-coordinate of the bacterium&#39;s center from the previous time step.</span>
<span class="sd">          - `prev_time_step_center_y`: Y-coordinate of the bacterium&#39;s center from the previous time step.</span>

<span class="sd">        - **Endpoint Coordinates**:</span>
<span class="sd">          - `prev_time_step_endpoint1_X`: X-coordinate of the first endpoint from the previous time step.</span>
<span class="sd">          - `prev_time_step_endpoint1_Y`: Y-coordinate of the first endpoint from the previous time step.</span>
<span class="sd">          - `prev_time_step_endpoint2_X`: X-coordinate of the second endpoint from the previous time step.</span>
<span class="sd">          - `prev_time_step_endpoint2_Y`: Y-coordinate of the second endpoint from the previous time step.</span>

<span class="sd">        - **`bacteria_movement`**:</span>
<span class="sd">          The minimum movement of the bacterium across time steps, calculated as the smallest</span>
<span class="sd">          displacement among the center and endpoints.</span>

<span class="sd">        - **Trajectory Features**:</span>
<span class="sd">          - `direction_of_motion`: The angle (in radians) representing the trajectory direction.</span>
<span class="sd">          - `TrajectoryX`: X-component of the trajectory displacement.</span>
<span class="sd">          - `TrajectoryY`: Y-component of the trajectory displacement.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Prev_MajorAxisLength&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">selected_rows</span><span class="p">[</span><span class="s1">&#39;Prev_MajorAxisLength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Length_Change_Ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_rows</span><span class="p">[</span><span class="s1">&#39;Length_Change_Ratio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Prev_Center_X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_rows</span><span class="p">[</span><span class="s1">&#39;Prev_Center_X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Prev_Center_Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_rows</span><span class="p">[</span><span class="s1">&#39;Prev_Center_Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Prev_Endpoint1_X&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">selected_rows</span><span class="p">[</span><span class="s1">&#39;Prev_Endpoint1_X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Prev_Endpoint1_Y&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">selected_rows</span><span class="p">[</span><span class="s1">&#39;Prev_Endpoint1_Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Prev_Endpoint2_X&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">selected_rows</span><span class="p">[</span><span class="s1">&#39;Prev_Endpoint2_X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Prev_Endpoint2_Y&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">selected_rows</span><span class="p">[</span><span class="s1">&#39;Prev_Endpoint2_Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;Bacterium_Movement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_rows</span><span class="p">[</span><span class="s2">&quot;Bacterium_Movement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;Direction_of_Motion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_rows</span><span class="p">[</span><span class="s2">&quot;Direction_of_Motion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;TrajectoryX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_rows</span><span class="p">[</span><span class="s2">&quot;TrajectoryX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_rows</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;TrajectoryY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_rows</span><span class="p">[</span><span class="s2">&quot;TrajectoryY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="calculate_bacterial_life_history_features">
<a class="viewcode-back" href="../modules.html#helper.calculate_bacterial_life_history_features">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_bacterial_life_history_features</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">calc_all_features</span><span class="p">,</span> <span class="n">neighbor_df</span><span class="p">,</span> <span class="n">division_df</span><span class="p">,</span>
                                              <span class="n">center_coord_cols</span><span class="p">,</span> <span class="n">use_selected_rows</span><span class="p">,</span> <span class="n">original_df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates features related to the continuous life history of bacteria.</span>

<span class="sd">    This function computes various features for bacteria across time steps, such as changes in length,</span>
<span class="sd">    movement patterns, and directional motion.</span>

<span class="sd">    :param pandas.DataFrame dataframe:</span>
<span class="sd">        A DataFrame containing bacterial features across time steps.</span>
<span class="sd">    :param bool calc_all_features:</span>
<span class="sd">        If True, computes additional features such as length change ratio, trajectory direction,</span>
<span class="sd">        and updates neighbor interactions.</span>
<span class="sd">    :param pandas.DataFrame neighbor_df:</span>
<span class="sd">        A DataFrame containing information about neighboring bacteria.</span>
<span class="sd">    :param pandas.DataFrame division_df:</span>
<span class="sd">        A DataFrame containing division-related information for bacteria.</span>
<span class="sd">    :param dict center_coord_cols:</span>
<span class="sd">        A dictionary specifying the column names for x and y center coordinates.</span>
<span class="sd">        Expected keys:</span>
<span class="sd">        - `&#39;x&#39;`: Base column name for x-coordinate.</span>
<span class="sd">        - `&#39;y&#39;`: Base column name for y-coordinate.</span>
<span class="sd">    :param bool use_selected_rows:</span>
<span class="sd">        If True, updates features based on selected rows from the original DataFrame.</span>
<span class="sd">    :param pandas.DataFrame original_df:</span>
<span class="sd">        The original DataFrame (optional) for updating selected rows when `flag_selected_rows` is True.</span>

<span class="sd">    :returns:</span>
<span class="sd">        pandas.DataFrame: The updated DataFrame with the following newly computed features:</span>

<span class="sd">        - **Length Change Ratio** (`LengthChangeRatio`):</span>
<span class="sd">          The ratio of the major axis length between the current and previous time steps.</span>

<span class="sd">        - **Movement** (`bacteria_movement`):</span>
<span class="sd">          The minimum movement of the bacterium across time steps, calculated as the smallest</span>
<span class="sd">          displacement among the center and endpoints.</span>

<span class="sd">        - **Direction of Motion**:</span>

<span class="sd">          - `direction_of_motion`: The angle (in radians) representing the trajectory direction.</span>
<span class="sd">          - `TrajectoryX` and `TrajectoryY`: The x and y components of the trajectory displacement.</span>

<span class="sd">        - **Neighbor Interactions**:</span>
<span class="sd">          Updates direction of motion (`direction_of_motion`) based on neighboring bacteria&#39;s</span>
<span class="sd">          trajectories and interactions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">calc_all_features</span><span class="p">:</span>
        <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Prev_MajorAxisLength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="s2">&quot;AreaShape_MajorAxisLength&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Length_Change_Ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;AreaShape_MajorAxisLength&quot;</span><span class="p">]</span> <span class="o">/</span>
                                          <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Prev_MajorAxisLength&#39;</span><span class="p">])</span>

    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Prev_Center_X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Prev_Center_Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Prev_Endpoint1_X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Prev_Endpoint1_Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="s2">&quot;Endpoint1_Y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Prev_Endpoint2_X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="s2">&quot;Endpoint2_X&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Prev_Endpoint2_Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="s2">&quot;Endpoint2_Y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">center_movement</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                       <span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;Prev_Center_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Prev_Center_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">endpoint1_1_movement</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                       <span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;Prev_Endpoint1_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Prev_Endpoint1_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">endpoint1_endpoint2_movement</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                       <span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;Prev_Endpoint2_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Prev_Endpoint2_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">endpoint2_2_movement</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                       <span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;Prev_Endpoint2_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Prev_Endpoint2_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">endpoint2_endpoint1_movement</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
                       <span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;Prev_Endpoint1_X&#39;</span><span class="p">,</span> <span class="s1">&#39;Prev_Endpoint1_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Bacterium_Movement&quot;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">center_movement</span><span class="p">,</span> <span class="n">endpoint1_1_movement</span><span class="p">,</span> <span class="n">endpoint2_2_movement</span><span class="p">,</span>
                           <span class="n">endpoint1_endpoint2_movement</span><span class="p">,</span> <span class="n">endpoint2_endpoint1_movement</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">calc_all_features</span><span class="p">:</span>

        <span class="n">bac_need_to_cal_dir_motion_condition</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Direction_of_Motion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>

        <span class="n">direction_of_motion</span> <span class="o">=</span> \
            <span class="n">calculate_trajectory_angles</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="n">bac_need_to_cal_dir_motion_condition</span><span class="p">],</span>
                                        <span class="n">center_coord_cols</span><span class="p">)</span>

        <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bac_need_to_cal_dir_motion_condition</span><span class="p">,</span> <span class="s2">&quot;Direction_of_Motion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">direction_of_motion</span>

        <span class="n">calculated_trajectory_x</span> <span class="o">=</span> <span class="n">calculate_trajectory_displacement</span><span class="p">(</span>
            <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bac_need_to_cal_dir_motion_condition</span><span class="p">],</span>
            <span class="n">center_coord_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

        <span class="n">calculated_trajectory_y</span> <span class="o">=</span> <span class="n">calculate_trajectory_displacement</span><span class="p">(</span>
            <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bac_need_to_cal_dir_motion_condition</span><span class="p">],</span>
            <span class="n">center_coord_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

        <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bac_need_to_cal_dir_motion_condition</span><span class="p">,</span> <span class="s1">&#39;TrajectoryX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculated_trajectory_x</span>
        <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bac_need_to_cal_dir_motion_condition</span><span class="p">,</span> <span class="s1">&#39;TrajectoryY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculated_trajectory_y</span>

        <span class="k">if</span> <span class="n">use_selected_rows</span><span class="p">:</span>

            <span class="n">original_df</span> <span class="o">=</span> <span class="n">update_dataframe_with_selected_rows</span><span class="p">(</span><span class="n">original_df</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">)</span>
            <span class="n">selected_rows</span> <span class="o">=</span> <span class="n">original_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;ImageNumber&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;ImageNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&amp;</span>
                                            <span class="p">(</span><span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;ImageNumber&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;ImageNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())]</span>

            <span class="n">dataframe</span> <span class="o">=</span> <span class="n">calc_neighbors_dir_motion_all</span><span class="p">(</span><span class="n">original_df</span><span class="p">,</span> <span class="n">neighbor_df</span><span class="p">,</span> <span class="n">division_df</span><span class="p">,</span> <span class="n">selected_rows</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataframe</span> <span class="o">=</span> <span class="n">calc_neighbors_dir_motion_all</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">neighbor_df</span><span class="p">,</span> <span class="n">division_df</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataframe</span></div>



<div class="viewcode-block" id="calculate_trajectory_displacement">
<a class="viewcode-back" href="../modules.html#helper.calculate_trajectory_displacement">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_trajectory_displacement</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">center_coord_cols</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the displacement of objects along a specified axis between consecutive positions.</span>

<span class="sd">    This function computes the difference (displacement) between the current and previous positions</span>
<span class="sd">    of objects along a specified axis (x or y). It is useful for analyzing movement patterns or</span>
<span class="sd">    trajectories over time.</span>

<span class="sd">    :param pandas.DataFrame df:</span>
<span class="sd">        A DataFrame containing the current and previous positions of objects.</span>
<span class="sd">    :param dict center_coord_cols:</span>
<span class="sd">        A dictionary specifying the column names for the x and y coordinates of the current position.</span>
<span class="sd">        Expected keys:</span>
<span class="sd">        - `&#39;x&#39;`: Base column name for the x-coordinate.</span>
<span class="sd">        - `&#39;y&#39;`: Base column name for the y-coordinate.</span>
<span class="sd">    :param str axis:</span>
<span class="sd">        The axis along which to calculate the displacement. Must be one of:</span>
<span class="sd">        - `&#39;x&#39;`: Calculates displacement along the x-axis.</span>
<span class="sd">        - `&#39;y&#39;`: Calculates displacement along the y-axis.</span>

<span class="sd">    :returns:</span>
<span class="sd">        pandas.Series: A Series containing the displacements along the specified axis.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Calculate the direction vector from the previous position to the current position</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Prev_Center_X&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Prev_Center_Y&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="calculate_trajectory_angles">
<a class="viewcode-back" href="../modules.html#helper.calculate_trajectory_angles">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_trajectory_angles</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">center_coord_cols</span><span class="p">,</span> <span class="n">suffix1</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">suffix2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the angles of trajectory directions between two objects.</span>

<span class="sd">    This function computes the direction vector between two bacteria and calculates the angle of that direction in</span>
<span class="sd">    radians. The angles are measured counterclockwise from the positive x-axis.</span>

<span class="sd">    :param pandas.DataFrame df:</span>
<span class="sd">        A DataFrame containing the x and y coordinates for two positions of objects.</span>
<span class="sd">        These positions are used to calculate the trajectory direction.</span>
<span class="sd">    :param dict center_coord_cols:</span>
<span class="sd">        A dictionary specifying the column names for the x and y coordinates of object centers.</span>
<span class="sd">    :param str suffix1:</span>
<span class="sd">        A suffix added to the base column names in `center_coord_cols` to identify the first set of positions.</span>
<span class="sd">        Default is an empty string.</span>
<span class="sd">    :param str suffix2:</span>
<span class="sd">        An optional suffix added to the base column names in `center_coord_cols` to identify the second set of</span>
<span class="sd">        positions. If not provided, the function assumes the second set of positions corresponds to columns</span>
<span class="sd">        prefixed with `prev_time_step`.</span>

<span class="sd">    :returns:</span>
<span class="sd">        np.ndarray: A 1D array of angles (in radians) corresponding to the direction of trajectory for</span>
<span class="sd">        each object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Calculate the direction vector from the previous position to the current position</span>
    <span class="k">if</span> <span class="n">suffix2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trajectory_direction</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">suffix1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">suffix1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
             <span class="n">df</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;Prev_Center_X</span><span class="si">{</span><span class="n">suffix1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Prev_Center_Y</span><span class="si">{</span><span class="n">suffix1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trajectory_direction</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">suffix1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">suffix1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span>
             <span class="n">df</span><span class="p">[[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">suffix2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">suffix2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># Calculate the angle of the direction vector</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">trajectory_direction</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">trajectory_direction</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">angle</span></div>



<div class="viewcode-block" id="calculate_all_bac_slopes">
<a class="viewcode-back" href="../modules.html#helper.calculate_all_bac_slopes">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_all_bac_slopes</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the slopes of lines formed by bacterial endpoints in the input DataFrame.</span>

<span class="sd">    This function determines the slope for each bacterium based on its two endpoints</span>
<span class="sd">    (`endpoint1_X`, `endpoint1_Y`, `endpoint2_X`, `endpoint2_Y`) provided in the input DataFrame.</span>
<span class="sd">    The slope is calculated for all bacteria, with special handling for vertical lines</span>
<span class="sd">    (where the slope is undefined).</span>

<span class="sd">    :param pandas.DataFrame df:</span>
<span class="sd">        A DataFrame containing columns for bacterial endpoints:</span>
<span class="sd">        - `endpoint1_X`, `endpoint1_Y`: Coordinates of the first endpoint.</span>
<span class="sd">        - `endpoint2_X`, `endpoint2_Y`: Coordinates of the second endpoint.</span>

<span class="sd">    :returns:</span>
<span class="sd">        pandas.DataFrame: The input DataFrame with an additional column:</span>

<span class="sd">        - **bacteria_slope**: The slope of the line formed by the bacterial endpoints.</span>
<span class="sd">          NaN is assigned for vertical lines.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">],</span> <span class="s1">&#39;Bacterium_Slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">],</span> <span class="s1">&#39;Bacterium_Slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Endpoint2_Y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Endpoint1_Y&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">df</span></div>



<span class="c1"># find vertices of an ellipse (bacteria):</span>
<span class="c1"># references:</span>
<span class="c1"># https://math.stackexchange.com/questions/426150/what-is-the-general-equation-of-the-ellipse-that-is-not-in-the-origin-and-rotate</span>
<span class="c1"># https://math.stackexchange.com/questions/2645689/what-is-the-parametric-equation-of-a-rotated-ellipse-given-the-angle-of-rotatio</span>
<div class="viewcode-block" id="calculate_bac_endpoints">
<a class="viewcode-back" href="../modules.html#helper.calculate_bac_endpoints">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_bac_endpoints</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">angle_rotation</span><span class="p">,</span> <span class="n">angle_tolerance</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the endpoints of the major axis of a bacterium based on its center, length, and orientation.</span>

<span class="sd">    This function computes the two endpoints of the major axis for a bacterium given its center coordinates,</span>
<span class="sd">    major axis length, and orientation angle. It handles three cases: bacteria aligned with the vertical axis,</span>
<span class="sd">    bacteria aligned with the horizontal axis, and bacteria with arbitrary orientations.</span>

<span class="sd">    **Mathematical Explanation**:</span>

<span class="sd">    - **Condition 1**: Bacteria parallel to the vertical axis :math:`\pi / 2`.</span>
<span class="sd">      For bacteria with orientation close to :math:`\pm \pi / 2` (absolute difference less than :math:`10^{-6}`),</span>
<span class="sd">      the endpoints are calculated as:</span>

<span class="sd">      .. math::</span>

<span class="sd">          (x_{\t{end1}}, y_{\t{end1}}) = (x_{\t{center}}, y_{\t{center}} + L)</span>

<span class="sd">          (x_{\t{end2}}, y_{\t{end2}}) = (x_{\t{center}}, y_{\t{center}} - L)</span>

<span class="sd">      where :math:`L` is the major axis length.</span>

<span class="sd">    - **Condition 2**: Bacteria parallel to the horizontal axis.</span>
<span class="sd">      For bacteria with orientation close to 0 (absolute difference less than :math:`10^{-6}`):</span>

<span class="sd">      .. math::</span>

<span class="sd">          (x_{\t{end1}}, y_{\t{end1}}) = (x_{\t{center}} + L, y_{\t{center}})</span>

<span class="sd">          (x_{\t{end2}}, y_{\t{end2}}) = (x_{\t{center}} - L, y_{\t{center}})</span>


<span class="sd">    - **Condition 3**: Non-axis-aligned bacteria:</span>
<span class="sd">      &quot;For bacteria with arbitrary orientation :math:`\\theta`, the endpoints are computed using the</span>
<span class="sd">      following formulas:&quot;</span>

<span class="sd">      .. math::</span>

<span class="sd">          x_{\t{end1}} = x_{\t{center}} + \\frac{L}{2} \\cdot \\cos(\\theta)</span>

<span class="sd">          y_{\t{end1}} = y_{\t{center}} + (x_{\t{end1}} - x_{\t{center}}) \\cdot \\tan(\\theta)</span>

<span class="sd">          x_{\t{end2}} = x_{\t{center}} - \\frac{L}{2} \\cdot \\cos(\\theta)</span>

<span class="sd">          y_{\t{end2}} = y_{\t{center}} + (x_{\t{end2}} - x_{\t{center}}) \\cdot \\tan(\\theta)</span>

<span class="sd">    - Endpoint selection ensures correct ordering along the major axis.</span>

<span class="sd">    :param list center:</span>
<span class="sd">        A list containing the x and y coordinates of the bacterium&#39;s center (e.g., `(x_center, y_center)`).</span>
<span class="sd">    :param float major:</span>
<span class="sd">        The length of the major axis of the bacterium.</span>
<span class="sd">    :param float angle_rotation:</span>
<span class="sd">        The orientation angle of the bacterium in radians.</span>
<span class="sd">    :param float angle_tolerance:</span>
<span class="sd">        The tolerance for detecting vertical or horizontal orientations (default: 1e-6).</span>

<span class="sd">    :returns:</span>
<span class="sd">        list: A list containing two sub lists for the endpoints:</span>
<span class="sd">        - `[x_end1, y_end1]`: Coordinates of the first endpoint.</span>
<span class="sd">        - `[x_end2, y_end2]`: Coordinates of the second endpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Bacteria parallel to the vertical axis</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle_rotation</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">angle_tolerance</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle_rotation</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">angle_tolerance</span><span class="p">:</span>
        <span class="n">vertex_1_x</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vertex_1_y</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">major</span>
        <span class="n">vertex_2_x</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vertex_2_y</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">major</span>

    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle_rotation</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">angle_tolerance</span><span class="p">:</span>  <span class="c1"># Bacteria parallel to the horizontal axis</span>
        <span class="n">vertex_1_x</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">major</span>
        <span class="n">vertex_1_y</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vertex_2_x</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">major</span>
        <span class="n">vertex_2_y</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># (x- center_x) * np.sin(angle_rotation) - (y-center_y) * np.cos(angle_rotation) = 0</span>
        <span class="c1"># np.power((x - center_x) * np.cos(angle_rotation) + (y - center_y) * np.sin(angle_rotation), 2) =</span>
        <span class="c1"># np.power(major, 2)</span>
        <span class="c1"># vertex_1_x = semi_major / (np.cos(angle_rotation) + np.tan(angle_rotation) * np.sin(angle_rotation)) +</span>
        <span class="c1">#              center[0]</span>
        <span class="c1"># vertex_2_x = -semi_major / (np.cos(angle_rotation) + np.tan(angle_rotation) * np.sin(angle_rotation)) +</span>
        <span class="c1">#               center[0]</span>

        <span class="n">semi_major</span> <span class="o">=</span> <span class="n">major</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">temp_vertex_1_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">semi_major</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rotation</span><span class="p">))</span> <span class="o">+</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">temp_vertex_1_y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">temp_vertex_1_x</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">angle_rotation</span><span class="p">)</span> <span class="o">+</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">temp_vertex_2_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="o">-</span> <span class="n">semi_major</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rotation</span><span class="p">))</span> <span class="o">+</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">temp_vertex_2_y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">temp_vertex_2_x</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">angle_rotation</span><span class="p">)</span> <span class="o">+</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">temp_vertex_1_x</span> <span class="o">&gt;</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">vertex_1_x</span> <span class="o">=</span> <span class="n">temp_vertex_1_x</span>
            <span class="n">vertex_1_y</span> <span class="o">=</span> <span class="n">temp_vertex_1_y</span>
            <span class="n">vertex_2_x</span> <span class="o">=</span> <span class="n">temp_vertex_2_x</span>
            <span class="n">vertex_2_y</span> <span class="o">=</span> <span class="n">temp_vertex_2_y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vertex_1_x</span> <span class="o">=</span> <span class="n">temp_vertex_2_x</span>
            <span class="n">vertex_1_y</span> <span class="o">=</span> <span class="n">temp_vertex_2_y</span>
            <span class="n">vertex_2_x</span> <span class="o">=</span> <span class="n">temp_vertex_1_x</span>
            <span class="n">vertex_2_y</span> <span class="o">=</span> <span class="n">temp_vertex_1_y</span>

    <span class="k">return</span> <span class="p">[[</span><span class="n">vertex_1_x</span><span class="p">,</span> <span class="n">vertex_1_y</span><span class="p">],</span> <span class="p">[</span><span class="n">vertex_2_x</span><span class="p">,</span> <span class="n">vertex_2_y</span><span class="p">]]</span></div>



<div class="viewcode-block" id="calculate_all_bac_endpoints">
<a class="viewcode-back" href="../modules.html#helper.calculate_all_bac_endpoints">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_all_bac_endpoints</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">center_coord_cols</span><span class="p">,</span> <span class="n">angle_tolerance</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the endpoints of bacterial major axes based on orientation, length, and position.</span>

<span class="sd">    This function determines the two endpoints of a bacterium&#39;s major axis by considering its orientation</span>
<span class="sd">    (parallel to vertical, horizontal, or otherwise) and center coordinates.</span>

<span class="sd">    **Mathematical Explanation**:</span>

<span class="sd">    - **Condition 1**: Bacteria parallel to the vertical axis :math:`\pi / 2`.</span>
<span class="sd">      For bacteria with orientation close to :math:`\pm \pi / 2` (absolute difference less than :math:`10^{-6}`),</span>
<span class="sd">      the endpoints are calculated as:</span>

<span class="sd">      .. math::</span>

<span class="sd">          (x_{\t{end1}}, y_{\t{end1}}) = (x_{\t{center}}, y_{\t{center}} + L)</span>

<span class="sd">          (x_{\t{end2}}, y_{\t{end2}}) = (x_{\t{center}}, y_{\t{center}} - L)</span>

<span class="sd">      where :math:`L` is the major axis length.</span>

<span class="sd">    - **Condition 2**: Bacteria parallel to the horizontal axis.</span>
<span class="sd">      For bacteria with orientation close to 0 (absolute difference less than :math:`10^{-6}`):</span>

<span class="sd">      .. math::</span>

<span class="sd">          (x_{\t{end1}}, y_{\t{end1}}) = (x_{\t{center}} + L, y_{\t{center}})</span>

<span class="sd">          (x_{\t{end2}}, y_{\t{end2}}) = (x_{\t{center}} - L, y_{\t{center}})</span>


<span class="sd">    - **Condition 3**: Non-axis-aligned bacteria:</span>
<span class="sd">      &quot;For bacteria with arbitrary orientation :math:`\\theta`, the endpoints are computed using the</span>
<span class="sd">      following formulas:&quot;</span>

<span class="sd">      .. math::</span>

<span class="sd">          x_{\t{end1}} = x_{\t{center}} + \\frac{L}{2} \\cdot \\cos(\\theta)</span>

<span class="sd">          y_{\t{end1}} = y_{\t{center}} + (x_{\t{end1}} - x_{\t{center}}) \\cdot \\tan(\\theta)</span>

<span class="sd">          x_{\t{end2}} = x_{\t{center}} - \\frac{L}{2} \\cdot \\cos(\\theta)</span>

<span class="sd">          y_{\t{end2}} = y_{\t{center}} + (x_{\t{end2}} - x_{\t{center}}) \\cdot \\tan(\\theta)</span>

<span class="sd">    - Endpoint selection ensures correct ordering along the major axis.</span>

<span class="sd">    :param pandas.DataFrame df:</span>
<span class="sd">        A DataFrame containing bacterial data, including orientation, center coordinates,</span>
<span class="sd">        and major axis length.</span>
<span class="sd">    :param dict center_coord_cols:</span>
<span class="sd">        A dictionary with keys &#39;x&#39; and &#39;y&#39;, specifying the column names for center coordinates.</span>
<span class="sd">    :param float angle_tolerance:</span>
<span class="sd">        The tolerance for detecting vertical or horizontal orientations (default: 1e-6).</span>

<span class="sd">    :returns:</span>
<span class="sd">        pandas.DataFrame: The modified DataFrame with additional columns for endpoints:</span>
<span class="sd">        - `endpoint1_X`, `endpoint1_Y`: Coordinates of the first endpoint.</span>
<span class="sd">        - `endpoint2_X`, `endpoint2_Y`: Coordinates of the second endpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># condition 1</span>
    <span class="c1"># Bacteria parallel to the vertical axis</span>
    <span class="n">condition1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;AreaShape_Orientation&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">angle_tolerance</span><span class="p">)</span> <span class="o">|</span> \
                 <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;AreaShape_Orientation&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">angle_tolerance</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition1</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition1</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;AreaShape_MajorAxisLength&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition1</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition1</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;AreaShape_MajorAxisLength&quot;</span><span class="p">]</span>

    <span class="c1"># Bacteria parallel to the horizontal axis</span>
    <span class="n">condition2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;AreaShape_Orientation&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">angle_tolerance</span>
    <span class="n">condition3</span> <span class="o">=</span> <span class="o">~</span><span class="n">condition1</span> <span class="o">&amp;</span> <span class="n">condition2</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition3</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;AreaShape_MajorAxisLength&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition3</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition3</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;AreaShape_MajorAxisLength&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition3</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span>

    <span class="c1"># (x- center_x) * np.sin(angle_rotation) - (y-center_y) * np.cos(angle_rotation) = 0</span>
    <span class="c1"># np.power((x - center_x) * np.cos(angle_rotation) + (y - center_y) * np.sin(angle_rotation), 2) =</span>
    <span class="c1"># np.power(major, 2)</span>
    <span class="n">condition4</span> <span class="o">=</span> <span class="o">~</span><span class="n">condition1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">condition2</span>
    <span class="n">other_bac_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition4</span><span class="p">][[</span><span class="s2">&quot;AreaShape_MajorAxisLength&quot;</span><span class="p">,</span> <span class="s2">&quot;AreaShape_Orientation&quot;</span><span class="p">,</span>
                                       <span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;semi_major&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;AreaShape_MajorAxisLength&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">(</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;semi_major&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s2">&quot;AreaShape_Orientation&quot;</span><span class="p">])</span> <span class="o">+</span>
         <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]])</span>

    <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_y&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">((</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]])</span> <span class="o">*</span>
         <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s2">&quot;AreaShape_Orientation&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]])</span>

    <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_2_x&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">(</span><span class="o">-</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;semi_major&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s2">&quot;AreaShape_Orientation&quot;</span><span class="p">])</span> <span class="o">+</span>
         <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]])</span>

    <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_2_y&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">((</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_2_x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]])</span> <span class="o">*</span>
         <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s2">&quot;AreaShape_Orientation&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]])</span>

    <span class="n">other_bac_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]],</span> <span class="s1">&#39;vertex_1_x&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span>
    <span class="n">other_bac_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]],</span> <span class="s1">&#39;vertex_1_y&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_y&#39;</span><span class="p">]</span>
    <span class="n">other_bac_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]],</span> <span class="s1">&#39;vertex_2_x&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_2_x&#39;</span><span class="p">]</span>
    <span class="n">other_bac_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]],</span> <span class="s1">&#39;vertex_2_y&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_2_y&#39;</span><span class="p">]</span>

    <span class="n">other_bac_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]],</span> <span class="s1">&#39;vertex_1_x&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_2_x&#39;</span><span class="p">]</span>
    <span class="n">other_bac_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]],</span> <span class="s1">&#39;vertex_1_y&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_2_y&#39;</span><span class="p">]</span>
    <span class="n">other_bac_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]],</span> <span class="s1">&#39;vertex_2_x&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span>
    <span class="n">other_bac_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]],</span> <span class="s1">&#39;vertex_2_y&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;temp_vertex_1_y&#39;</span><span class="p">]</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition4</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;vertex_1_x&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition4</span><span class="p">,</span> <span class="s1">&#39;Endpoint1_Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;vertex_1_y&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition4</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;vertex_2_x&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">condition4</span><span class="p">,</span> <span class="s1">&#39;Endpoint2_Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_bac_df</span><span class="p">[</span><span class="s1">&#39;vertex_2_y&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="convert_angle_to_radian">
<a class="viewcode-back" href="../modules.html#helper.convert_angle_to_radian">[docs]</a>
<span class="k">def</span> <span class="nf">convert_angle_to_radian</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts bacterial orientation angles from degrees to radians and modifies the values.</span>

<span class="sd">    The orientation is adjusted using the formula:</span>

<span class="sd">    .. math::</span>
<span class="sd">        Orientation (radian) = - \\frac{(\\text{Orientation (degrees)} + 90) \\cdot \\pi}{180}</span>

<span class="sd">    This ensures the angles are transformed to a range suitable for downstream computations.</span>

<span class="sd">    :param pandas.DataFrame df:</span>
<span class="sd">        A DataFrame containing a column named &quot;AreaShape_Orientation&quot; with orientation angles in degrees.</span>

<span class="sd">    :returns:</span>
<span class="sd">        pandas.DataFrame: The modified DataFrame with the &quot;AreaShape_Orientation&quot; column converted to radians.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># modification of bacterium orientation</span>
    <span class="c1"># -(angle + 90) * np.pi / 180</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;AreaShape_Orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;AreaShape_Orientation&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">90</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="extract_bacteria_features">
<a class="viewcode-back" href="../modules.html#helper.extract_bacteria_features">[docs]</a>
<span class="k">def</span> <span class="nf">extract_bacteria_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">center_coord_cols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts key geometric and spatial features of bacteria from the input DataFrame.</span>

<span class="sd">    This function retrieves the major axis length, minor axis length, radius, orientation,</span>
<span class="sd">    and center coordinates of bacteria, organizing them into a dictionary for further use.</span>

<span class="sd">    :param pandas.DataFrame df:</span>
<span class="sd">        A DataFrame containing bacterial data with required columns for shape and position.</span>
<span class="sd">    :param dict center_coord_cols:</span>
<span class="sd">        A dictionary with keys &#39;x&#39; and &#39;y&#39;, specifying the column names for center coordinates.</span>

<span class="sd">    :returns:</span>
<span class="sd">        dict: A dictionary containing the extracted features:</span>
<span class="sd">        - &#39;major&#39;: Major axis length of bacteria.</span>
<span class="sd">        - &#39;minor&#39;: Minor axis length of bacteria.</span>
<span class="sd">        - &#39;orientation&#39;: Orientation of the bacteria (e.g., angle or direction).</span>
<span class="sd">        - &#39;center_x&#39;: X-coordinate of the bacteria&#39;s center.</span>
<span class="sd">        - &#39;center_y&#39;: Y-coordinate of the bacteria&#39;s center.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">major</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AreaShape_MajorAxisLength&#39;</span><span class="p">]</span>
    <span class="n">minor</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AreaShape_MinorAxisLength&#39;</span><span class="p">]</span>
    <span class="n">orientation</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AreaShape_Orientation&#39;</span><span class="p">]</span>
    <span class="n">center_x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span>
    <span class="n">center_y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;major&#39;</span><span class="p">:</span> <span class="n">major</span><span class="p">,</span> <span class="s1">&#39;minor&#39;</span><span class="p">:</span> <span class="n">minor</span><span class="p">,</span> <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="n">orientation</span><span class="p">,</span> <span class="s1">&#39;center_x&#39;</span><span class="p">:</span> <span class="n">center_x</span><span class="p">,</span>
                <span class="s1">&#39;center_y&#39;</span><span class="p">:</span> <span class="n">center_y</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">features</span></div>



<div class="viewcode-block" id="calc_normalized_angle_between_motion_for_df">
<a class="viewcode-back" href="../modules.html#helper.calc_normalized_angle_between_motion_for_df">[docs]</a>
<span class="k">def</span> <span class="nf">calc_normalized_angle_between_motion_for_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target_bac_motion_x_col</span><span class="p">,</span> <span class="n">target_bac_motion_y_col</span><span class="p">,</span>
                                                <span class="n">neighbors_avg_dir_motion_x</span><span class="p">,</span> <span class="n">neighbors_avg_dir_motion_y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the normalized angles between motion vectors for each row in a DataFrame.</span>

<span class="sd">    This function computes the angle between a motion vector and its neighbors&#39; average motion vector</span>
<span class="sd">    for each row in the DataFrame. The angles are normalized by dividing by 180 degrees.</span>

<span class="sd">    **Mathematical Explanation**:</span>

<span class="sd">    - **Dot Product**:</span>
<span class="sd">      The dot product of two vectors is a measure of how aligned they are. For two vectors:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\mathbf{v_1} = (x_1, y_1), \\quad \\mathbf{v_2} = (x_2, y_2)</span>

<span class="sd">      The dot product is given by:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\mathbf{v_1} \\cdot \\mathbf{v_2} = x_1 \\cdot x_2 + y_1 \\cdot y_2</span>

<span class="sd">    - **Magnitude of a Vector**:</span>
<span class="sd">      The magnitude (length) of a vector is calculated as:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\| \\mathbf{v} \\| = \\sqrt{x^2 + y^2}</span>

<span class="sd">    - **Cosine of the Angle**:</span>
<span class="sd">      The cosine of the angle \\( \\theta \\) between two vectors is computed as:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\cos(\\theta) = \\frac{\\mathbf{v_1} \\cdot \\mathbf{v_2}}{\\| \\mathbf{v_1} \\| \\| \\mathbf{v_2} \\|}</span>

<span class="sd">      If either vector has zero magnitude, the cosine is undefined.</span>

<span class="sd">    - **Angle in Radians**:</span>
<span class="sd">      The angle \\( \\theta \\) in radians is obtained using the arccosine function:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\theta = \\arccos(\\cos(\\theta))</span>

<span class="sd">      To handle numerical precision, the cosine value is clipped to the range \\([-1, 1]\\).</span>

<span class="sd">    - **Convert Radians to Degrees**:</span>
<span class="sd">      The angle is converted from radians to degrees using the formula:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\text{Angle (degrees)} = \\frac{\\theta \\cdot 180}{\\pi}</span>

<span class="sd">    - **Normalized Angle**:</span>
<span class="sd">      Finally, the angle is normalized by dividing the degrees by 180:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\text{Normalized Angle} = \\frac{\\text{Angle (degrees)}}{180}</span>

<span class="sd">    :param pandas.DataFrame df:</span>
<span class="sd">        A DataFrame containing direction of motion of objects and average direction of motion of neighbors.</span>
<span class="sd">    :param str target_bac_motion_x_col:</span>
<span class="sd">        The column name for the x-component of the object&#39;s motion vector.</span>
<span class="sd">    :param str target_bac_motion_y_col:</span>
<span class="sd">        The column name for the y-component of the object&#39;s motion vector.</span>
<span class="sd">    :param str neighbors_avg_dir_motion_x:</span>
<span class="sd">        The column name for the x-component of the neighbors&#39; average motion vector.</span>
<span class="sd">    :param str neighbors_avg_dir_motion_y:</span>
<span class="sd">        The column name for the y-component of the neighbors&#39; average motion vector.</span>

<span class="sd">    :returns:</span>
<span class="sd">        np.ndarray: A 1D array of normalized angles (0 to 1) for each row.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span><span class="p">[</span><span class="n">target_bac_motion_x_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target_bac_motion_x_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">target_bac_motion_y_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target_bac_motion_y_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">neighbors_avg_dir_motion_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">neighbors_avg_dir_motion_x</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">neighbors_avg_dir_motion_y</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">neighbors_avg_dir_motion_y</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Calculate the dot product</span>
    <span class="n">dot_product</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target_bac_motion_x_col</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="n">neighbors_avg_dir_motion_x</span><span class="p">]</span> <span class="o">+</span>
                   <span class="n">df</span><span class="p">[</span><span class="n">target_bac_motion_y_col</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="n">neighbors_avg_dir_motion_y</span><span class="p">])</span>

    <span class="c1"># Calculate the magnitudes of the vectors</span>
    <span class="n">magnitude_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target_bac_motion_x_col</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target_bac_motion_y_col</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">magnitude_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">neighbors_avg_dir_motion_x</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">neighbors_avg_dir_motion_y</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Calculate the cosine of the angle, handling division by zero</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">magnitude_a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">magnitude_b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                             <span class="n">dot_product</span> <span class="o">/</span> <span class="p">(</span><span class="n">magnitude_a</span> <span class="o">*</span> <span class="n">magnitude_b</span><span class="p">),</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Calculate the angle in radians and then convert to degrees</span>
    <span class="n">angle_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">angle_degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_radians</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;angle_degrees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle_degrees</span> <span class="o">/</span> <span class="mi">180</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="calculate_normalized_angle_between_motion_vectors">
<a class="viewcode-back" href="../modules.html#helper.calculate_normalized_angle_between_motion_vectors">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_normalized_angle_between_motion_vectors</span><span class="p">(</span><span class="n">neighbor_motion_vectors</span><span class="p">,</span> <span class="n">target_motion_vectors</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the normalized angle (0 to 1) between two sets of direction of motion vectors.</span>

<span class="sd">    This function computes the angles between corresponding direction of motion vectors in two arrays,</span>
<span class="sd">    normalizes the angles by dividing by 180, and returns the result.</span>

<span class="sd">    **Mathematical Explanation**:</span>

<span class="sd">    - **Dot Product**:</span>
<span class="sd">      The dot product of two vectors is a measure of how aligned they are. For two vectors:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\mathbf{v_1} = (x_1, y_1), \\quad \\mathbf{v_2} = (x_2, y_2)</span>

<span class="sd">      The dot product is given by:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\mathbf{v_1} \\cdot \\mathbf{v_2} = x_1 \\cdot x_2 + y_1 \\cdot y_2</span>

<span class="sd">    - **Magnitude of a Vector**:</span>
<span class="sd">      The magnitude (length) of a vector is calculated as:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\| \\mathbf{v} \\| = \\sqrt{x^2 + y^2}</span>

<span class="sd">    - **Cosine of the Angle**:</span>
<span class="sd">      The cosine of the angle \\( \\theta \\) between two vectors is computed as:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\cos(\\theta) = \\frac{\\mathbf{v_1} \\cdot \\mathbf{v_2}}{\\| \\mathbf{v_1} \\| \\| \\mathbf{v_2} \\|}</span>

<span class="sd">      If either vector has zero magnitude, the cosine is undefined.</span>

<span class="sd">    - **Angle in Radians**:</span>
<span class="sd">      The angle \\( \\theta \\) in radians is obtained using the arccosine function:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\theta = \\arccos(\\cos(\\theta))</span>

<span class="sd">      To handle numerical precision, the cosine value is clipped to the range \\([-1, 1]\\).</span>

<span class="sd">    - **Convert Radians to Degrees**:</span>
<span class="sd">      The angle is converted from radians to degrees using the formula:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\text{Angle (degrees)} = \\frac{\\theta \\cdot 180}{\\pi}</span>

<span class="sd">    - **Normalized Angle**:</span>
<span class="sd">      Finally, the angle is normalized by dividing the degrees by 180:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\text{Normalized Angle} = \\frac{\\text{Angle (degrees)}}{180}</span>

<span class="sd">    :param np.ndarray neighbor_motion_vectors:</span>
<span class="sd">        A 2D array where each row represents a direction of motion vector for neighbors.</span>
<span class="sd">    :param np.ndarray target_motion_vectors:</span>
<span class="sd">        A 2D array where each row represents a vector for target motions.</span>

<span class="sd">    :returns:</span>
<span class="sd">        A 1D array of normalized angles (0 to 1) between the vectors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Dot product</span>
    <span class="n">dot_product</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">neighbor_motion_vectors</span> <span class="o">*</span> <span class="n">target_motion_vectors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Magnitudes</span>
    <span class="n">magnitude_neighbors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">neighbor_motion_vectors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">magnitude_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">target_motion_vectors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Safe division (avoid division by zero)</span>
    <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">magnitude_neighbors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">magnitude_direction</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">dot_product</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># Initialize with NaNs</span>

    <span class="n">cos_angle</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot_product</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">magnitude_neighbors</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span> <span class="o">*</span> <span class="n">magnitude_direction</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">])</span>

    <span class="c1"># Calculate the angle in radians and then convert to degrees</span>
    <span class="n">angle_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">)</span>
    <span class="n">angle_degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_radians</span><span class="p">)</span>

    <span class="n">angle_between_motions</span> <span class="o">=</span> <span class="n">angle_degrees</span> <span class="o">/</span> <span class="mi">180</span>  <span class="c1"># Normalize by 180</span>

    <span class="k">return</span> <span class="n">angle_between_motions</span></div>



<div class="viewcode-block" id="calculate_angles_between_slopes">
<a class="viewcode-back" href="../modules.html#helper.calculate_angles_between_slopes">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_angles_between_slopes</span><span class="p">(</span><span class="n">slope_a</span><span class="p">,</span> <span class="n">slope_b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the orientation angles between two slopes in degrees.</span>

<span class="sd">    This function computes the angle in degrees between two lines defined by their slopes.</span>
<span class="sd">    NaN values are replaced with 90 degrees to handle undefined cases (e.g., perpendicular lines).</span>



<span class="sd">    **Mathematical Explanation**:</span>

<span class="sd">    - **Angle Between Two Slopes**:</span>
<span class="sd">      The angle :math:`\\theta` between two lines with slopes :math:`m_1` and :math:`m_2` is given by:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\theta = \\arctan\\left( \\left| \\frac{m_1 - m_2}{1 + m_1 m_2} \\right| \\right)</span>

<span class="sd">      where:</span>
<span class="sd">        :math:`m_1` is the slope of the first line.</span>
<span class="sd">        :math:`m_2` is the slope of the second line.</span>

<span class="sd">    - **Convert Radians to Degrees**:</span>
<span class="sd">      The angle in degrees is calculated using:</span>

<span class="sd">      .. math::</span>

<span class="sd">          \\text{Angle (degrees)} = \\frac{\\theta \\cdot 180}{\\pi}</span>

<span class="sd">    - **Handling Undefined Cases**:</span>
<span class="sd">      When :math:`1 + m_1 m_2 = 0`, the angle is undefined (lines are perpendicular). In such cases,</span>
<span class="sd">      NaN values are replaced with 90 degrees.</span>

<span class="sd">    :param np.ndarray slope_a:</span>
<span class="sd">        An array of slope values for the first set of lines.</span>
<span class="sd">    :param np.ndarray slope_b:</span>
<span class="sd">        An array of slope values for the second set of lines.</span>

<span class="sd">    :returns:</span>
<span class="sd">        An array of angles in degrees between the lines.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Calculate the angle in radians between the lines</span>
    <span class="n">angle_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">slope_a</span> <span class="o">-</span> <span class="n">slope_b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">slope_a</span> <span class="o">*</span> <span class="n">slope_b</span><span class="p">)))</span>
    <span class="c1"># Convert to degrees</span>
    <span class="n">angle_degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_radians</span><span class="p">)</span>

    <span class="c1"># Replace NaN values with 90</span>
    <span class="n">angle_degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">angle_degrees</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">angle_degrees</span></div>



<div class="viewcode-block" id="calc_distance_matrix">
<a class="viewcode-back" href="../modules.html#helper.calc_distance_matrix">[docs]</a>
<span class="k">def</span> <span class="nf">calc_distance_matrix</span><span class="p">(</span><span class="n">target_bac_coords_df</span><span class="p">,</span> <span class="n">reference_bac_coords_df</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates a distance matrix between two sets of bacteria coordinates.</span>

<span class="sd">    This function computes the pairwise Euclidean distances between the coordinates of</span>
<span class="sd">    target bacteria and reference bacteria</span>

<span class="sd">    :param pandas.DataFrame target_bac_coords_df:</span>
<span class="sd">        A DataFrame containing the coordinates of the target bacteria.</span>
<span class="sd">    :param pandas.DataFrame reference_bac_coords_df:</span>
<span class="sd">        A DataFrame containing the coordinates of the reference bacteria.</span>
<span class="sd">    :param str x_col:</span>
<span class="sd">        The column name for the x-coordinate in both DataFrames.</span>
<span class="sd">    :param str y_col:</span>
<span class="sd">        The column name for the y-coordinate in both DataFrames.</span>

<span class="sd">    :returns:</span>
<span class="sd">        A pandas DataFrame representing the distance matrix, where rows correspond to</span>
<span class="sd">        `target_bac_coords_df` indices and columns correspond to `reference_bac_coords_df` indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">distance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">(</span><span class="n">target_bac_coords_df</span><span class="p">[[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                               <span class="n">reference_bac_coords_df</span><span class="p">[[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                               <span class="n">index</span><span class="o">=</span><span class="n">target_bac_coords_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">reference_bac_coords_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">distance_df</span></div>



<div class="viewcode-block" id="convert_end_points_um_to_pixel">
<a class="viewcode-back" href="../modules.html#helper.convert_end_points_um_to_pixel">[docs]</a>
<span class="k">def</span> <span class="nf">convert_end_points_um_to_pixel</span><span class="p">(</span><span class="n">end_points</span><span class="p">,</span> <span class="n">um_per_pixel</span><span class="o">=</span><span class="mf">0.144</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts endpoint coordinates from micrometers (um) to pixel units based on a specified conversion factor.</span>

<span class="sd">    :param list or np.array end_points:</span>
<span class="sd">        A list or array of endpoint coordinates in micrometers to be converted.</span>
<span class="sd">    :param float um_per_pixel:</span>
<span class="sd">        The conversion factor representing micrometers per pixel (default: 0.144).</span>

<span class="sd">    :returns:</span>
<span class="sd">        A numpy array of endpoint coordinates converted to pixel units.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">end_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_points</span><span class="p">)</span> <span class="o">/</span> <span class="n">um_per_pixel</span>

    <span class="k">return</span> <span class="n">end_points</span></div>



<div class="viewcode-block" id="convert_um_to_pixel">
<a class="viewcode-back" href="../modules.html#helper.convert_um_to_pixel">[docs]</a>
<span class="k">def</span> <span class="nf">convert_um_to_pixel</span><span class="p">(</span><span class="n">major_len</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">center_pos</span><span class="p">,</span> <span class="n">pixel_per_micron</span><span class="o">=</span><span class="mf">0.144</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts physical measurements in pixel to micrometers (um) based on a specified conversion factor.</span>

<span class="sd">    :param float major_len:</span>
<span class="sd">        The length measurement in um to be converted.</span>
<span class="sd">    :param float radius:</span>
<span class="sd">        The radius measurement in um to be converted.</span>
<span class="sd">    :param list or np.array endpoints:</span>
<span class="sd">        A list or array of endpoint coordinates in um.</span>
<span class="sd">    :param list or np.array center_pos:</span>
<span class="sd">        A list or array of center coordinate in um.</span>
<span class="sd">    :param float pixel_per_micron:</span>
<span class="sd">        The conversion factor representing pixel per micrometers(default: 0.144).</span>

<span class="sd">    :returns:</span>
<span class="sd">        A tuple containing the converted major_len, radius, endpoints, center_pos in pixel units.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">major_len</span> <span class="o">=</span> <span class="n">major_len</span> <span class="o">/</span> <span class="n">pixel_per_micron</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">/</span> <span class="n">pixel_per_micron</span>
    <span class="n">endpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">endpoints</span><span class="p">)</span> <span class="o">/</span> <span class="n">pixel_per_micron</span>
    <span class="n">center_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center_pos</span><span class="p">)</span> <span class="o">/</span> <span class="n">pixel_per_micron</span>

    <span class="k">return</span> <span class="n">major_len</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">center_pos</span></div>



<div class="viewcode-block" id="convert_pixel_to_um">
<a class="viewcode-back" href="../modules.html#helper.convert_pixel_to_um">[docs]</a>
<span class="k">def</span> <span class="nf">convert_pixel_to_um</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pixel_per_micron</span><span class="p">,</span> <span class="n">all_rel_center_coord_cols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts distance measurements from pixel units to micrometers (um)</span>
<span class="sd">        within a DataFrame based on a specified conversion factor.</span>

<span class="sd">        :param pandas.DataFrame df:</span>
<span class="sd">            The input DataFrame containing spatial and shape measurements in pixel units.</span>
<span class="sd">        :param float pixel_per_micron:</span>
<span class="sd">            The conversion factor representing micrometers per pixel.</span>
<span class="sd">        :param dict all_rel_center_coord_cols:</span>
<span class="sd">            A dictionary containing the column names for x and y center coordinates,</span>
<span class="sd">            e.g., {&#39;x&#39;: [&#39;Location_Center_X&#39;, &#39;AreaShape_Center_X&#39;], &#39;y&#39;: [&#39;Location_Center_Y&#39;, &#39;AreaShape_Center_Y&#39;]}.</span>

<span class="sd">        :returns:</span>
<span class="sd">            The modified DataFrame with measurements converted to micrometers.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="c1"># Convert distances to um</span>

    <span class="n">df</span><span class="p">[</span><span class="n">all_rel_center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">pixel_per_micron</span>

    <span class="n">df</span><span class="p">[</span><span class="n">all_rel_center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">pixel_per_micron</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AreaShape_MajorAxisLength&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">pixel_per_micron</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AreaShape_MinorAxisLength&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">pixel_per_micron</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="identify_important_columns">
<a class="viewcode-back" href="../modules.html#helper.identify_important_columns">[docs]</a>
<span class="k">def</span> <span class="nf">identify_important_columns</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identifies key columns related to center coordinates, labels, and parent objects</span>
<span class="sd">    from the provided DataFrame.</span>

<span class="sd">    :param pandas.DataFrame df:</span>
<span class="sd">        Input DataFrame containing columns with bacterial feature data, such as tracking information</span>
<span class="sd">        and spatial coordinates.</span>

<span class="sd">    :returns:</span>
<span class="sd">        tuple: A tuple containing:</span>

<span class="sd">        - **center_coord_cols** (*dict*): Primary center coordinate columns</span>
<span class="sd">          (e.g., {&#39;x&#39;: &#39;Location_Center_X&#39;, &#39;y&#39;: &#39;Location_Center_Y&#39;}).</span>
<span class="sd">        - **all_rel_center_coord_cols** (*dict*): All available center coordinate columns</span>
<span class="sd">          (e.g., {&#39;x&#39;: [&#39;Location_Center_X&#39;, &#39;AreaShape_Center_X&#39;], &#39;y&#39;: [&#39;Location_Center_Y&#39;, &#39;AreaShape_Center_Y&#39;]}).</span>
<span class="sd">        - **parent_image_number_col** (*str*): Name of the column for parent image number.</span>
<span class="sd">        - **parent_object_number_col** (*str*): Name of the column for parent object number.</span>
<span class="sd">        - **label_col** (*str*): Name of the column for object labels.</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parent_image_number_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;TrackObjects_ParentImageNumber_&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">parent_object_number_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;TrackObjects_ParentObjectNumber_&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># label column name</span>
    <span class="n">label_col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;TrackObjects_Label_&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_col_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">label_col</span> <span class="o">=</span> <span class="n">label_col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label_col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_col_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">label_col</span> <span class="o">=</span> <span class="n">label_col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_col</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s1">&#39;Location_Center_X&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;Location_Center_Y&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">center_coord_cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;Location_Center_X&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;Location_Center_Y&#39;</span><span class="p">}</span>
        <span class="n">all_rel_center_coord_cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Location_Center_X&#39;</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Location_Center_Y&#39;</span><span class="p">]}</span>

        <span class="k">if</span> <span class="s1">&#39;AreaShape_Center_X&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;AreaShape_Center_Y&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">all_rel_center_coord_cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Location_Center_X&#39;</span><span class="p">,</span> <span class="s1">&#39;AreaShape_Center_X&#39;</span><span class="p">],</span>
                                         <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Location_Center_Y&#39;</span><span class="p">,</span> <span class="s1">&#39;AreaShape_Center_Y&#39;</span><span class="p">]}</span>

    <span class="k">elif</span> <span class="s1">&#39;AreaShape_Center_X&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;AreaShape_Center_Y&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">center_coord_cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;AreaShape_Center_X&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;AreaShape_Center_Y&#39;</span><span class="p">}</span>
        <span class="n">all_rel_center_coord_cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AreaShape_Center_X&#39;</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AreaShape_Center_Y&#39;</span><span class="p">]}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No column corresponding to the center of bacteria.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">center_coord_cols</span><span class="p">,</span> <span class="n">all_rel_center_coord_cols</span><span class="p">,</span> <span class="n">parent_image_number_col</span><span class="p">,</span> <span class="n">parent_object_number_col</span><span class="p">,</span>
            <span class="n">label_col</span><span class="p">)</span></div>



<div class="viewcode-block" id="extract_bacteria_info">
<a class="viewcode-back" href="../modules.html#helper.extract_bacteria_info">[docs]</a>
<span class="k">def</span> <span class="nf">extract_bacteria_info</span><span class="p">(</span><span class="n">bacteria_data</span><span class="p">,</span> <span class="n">pixels_per_micron</span><span class="p">,</span> <span class="n">center_coord_cols</span><span class="p">,</span> <span class="n">major_axis_len_col</span><span class="p">,</span> <span class="n">orientation_col</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts and converts bacterial object information and convert from micrometers (Âµm) to pixel.</span>

<span class="sd">    This function processes spatial and shape information of bacterial objects</span>
<span class="sd">    from a given DataFrame. The center coordinates and major axis length are</span>
<span class="sd">    converted from micrometers to pixel using the provided conversion factor.</span>

<span class="sd">    :param pandas.DataFrame bacteria_data:</span>
<span class="sd">        A DataFrame containing information about bacterial objects, including</span>
<span class="sd">        spatial measurements and orientation.</span>
<span class="sd">    :param float pixels_per_micron:</span>
<span class="sd">        The conversion factor representing the number of pixels per micrometer.</span>
<span class="sd">    :param dict center_coord_cols:</span>
<span class="sd">        A dictionary specifying the column names for x and y center coordinates.</span>
<span class="sd">        Example: {&#39;x&#39;: &#39;Location_Center_X&#39;, &#39;y&#39;: &#39;Location_Center_Y&#39;}.</span>
<span class="sd">    :param str major_axis_len_col:</span>
<span class="sd">        The name of the column representing the major axis length of the objects (in pixels).</span>
<span class="sd">    :param str orientation_col:</span>
<span class="sd">        The name of the column representing the orientation of the objects</span>
<span class="sd">        (e.g., in degrees or radians, depending on the dataset).</span>

<span class="sd">    :returns:</span>
<span class="sd">        tuple: A tuple containing the following elements:</span>
<span class="sd">            - objects_center_x (pandas.Series): The x-coordinates of object centers in pixel.</span>
<span class="sd">            - objects_center_y (pandas.Series): The y-coordinates of object centers in pixel.</span>
<span class="sd">            - objects_major_axis (pandas.Series): The major axis length of objects in pixel.</span>
<span class="sd">            - objects_orientation (pandas.Series): The orientation of objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">objects_center_x</span> <span class="o">=</span> <span class="n">bacteria_data</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span> <span class="o">/</span> <span class="n">pixels_per_micron</span>
    <span class="n">objects_center_y</span> <span class="o">=</span> <span class="n">bacteria_data</span><span class="p">[</span><span class="n">center_coord_cols</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">/</span> <span class="n">pixels_per_micron</span>
    <span class="n">objects_major_axis</span> <span class="o">=</span> <span class="n">bacteria_data</span><span class="p">[</span><span class="n">major_axis_len_col</span><span class="p">]</span> <span class="o">/</span> <span class="n">pixels_per_micron</span>
    <span class="n">objects_orientation</span> <span class="o">=</span> <span class="n">bacteria_data</span><span class="p">[</span><span class="n">orientation_col</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">objects_center_x</span><span class="p">,</span> <span class="n">objects_center_y</span><span class="p">,</span> <span class="n">objects_major_axis</span><span class="p">,</span> <span class="n">objects_orientation</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Atiyeh Ahmadi
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=cb975c41"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>